DECLARE @BillingMonth      date    = '2025-09-01';
DECLARE @CP_Id             tinyint = 11;

DECLARE @ReceiptFromDate   date = DATEADD(MONTH, 1, @BillingMonth);
DECLARE @ReceiptToDate     date = EOMONTH(@ReceiptFromDate);

;WITH
Charges AS (
    SELECT c.CP_Id, c.Property_Id, ChargeMonth = c.dtDate, AmountDue = d.Amount
    FROM dbo.CommunityCharges c
    JOIN dbo.CommunityChargesDetail d
      ON d.CP_Id = c.CP_Id AND d.OC_Id = c.OC_Id AND d.FinYear = c.FinYear
    WHERE c.CP_Id = @CP_Id AND c.Status_Id = 10 AND c.dtDate <= @BillingMonth
),
MonthDuePerMonth AS (
    SELECT CP_Id, Property_Id, ChargeMonth, MonthwiseDueAmount = SUM(AmountDue)
    FROM Charges
    GROUP BY CP_Id, Property_Id, ChargeMonth
    HAVING SUM(AmountDue) > 0
),
TotalDueTill AS (
    SELECT CP_Id, Property_Id, TotalDueTill = SUM(MonthwiseDueAmount)
    FROM MonthDuePerMonth
    WHERE ChargeMonth <= @BillingMonth
    GROUP BY CP_Id, Property_Id
),
-- Get ALL receipts up to and including the billing month
AllReceiptsMapped AS (
    SELECT r.CP_Id, r.Property_Id,
           BillingMonthMapped = DATEADD(DAY, 1, EOMONTH(r.dtDate, -2)),
           Amount = r.Amount
    FROM dbo.CommunityReceipt r
    WHERE r.CP_Id = @CP_Id
      AND r.AppStatus_Id < 11
      AND r.dtDate <= @ReceiptToDate
),
-- Receipts for the current billing month only
MonthReceipt AS (
    SELECT CP_Id, Property_Id, ReceiptAmountThisMonth = SUM(Amount)
    FROM AllReceiptsMapped
    WHERE BillingMonthMapped = @BillingMonth
    GROUP BY CP_Id, Property_Id
),
-- ALL receipts before the current billing month
TotalReceiptTillPrev AS (
    SELECT CP_Id, Property_Id, TotalReceiptTillPrev = SUM(Amount)
    FROM AllReceiptsMapped
    WHERE BillingMonthMapped < @BillingMonth
    GROUP BY CP_Id, Property_Id
),
-- Calculate running balance per month (considering all previous receipts)
MonthwiseBalance AS (
    SELECT 
        md.CP_Id,
        md.Property_Id,
        md.ChargeMonth,
        md.MonthwiseDueAmount,
        -- Receipts allocated to THIS specific month in the past
        ReceiptForThisMonth = ISNULL((
            SELECT SUM(Amount)
            FROM AllReceiptsMapped arm
            WHERE arm.CP_Id = md.CP_Id 
              AND arm.Property_Id = md.Property_Id
              AND arm.BillingMonthMapped = md.ChargeMonth
        ), 0),
        -- Net balance for this month (negative means overpaid)
        MonthNetBalance = md.MonthwiseDueAmount - ISNULL((
            SELECT SUM(Amount)
            FROM AllReceiptsMapped arm
            WHERE arm.CP_Id = md.CP_Id 
              AND arm.Property_Id = md.Property_Id
              AND arm.BillingMonthMapped = md.ChargeMonth
        ), 0)
    FROM MonthDuePerMonth md
),
BaseProps AS (
    SELECT DISTINCT CP_Id, Property_Id
    FROM MonthDuePerMonth WHERE ChargeMonth = @BillingMonth
    UNION
    SELECT DISTINCT CP_Id, Property_Id FROM MonthReceipt
),
AllocRows AS (
    SELECT
        p.Property_Id,
        BillingMonth = @BillingMonth,
        mb.ChargeMonth,
        mb.MonthwiseDueAmount,
        mb.MonthNetBalance,
        ReceiptAmountThisMonth = ISNULL(mr.ReceiptAmountThisMonth, 0),
        TotalDueTill          = ISNULL(td.TotalDueTill, 0),
        TotalReceiptTillPrev  = ISNULL(trp.TotalReceiptTillPrev, 0),

        -- Only consider months with positive net balance (still have dues)
        RunningDuePrior = ISNULL(
            SUM(CASE WHEN mb.MonthNetBalance > 0 THEN mb.MonthNetBalance ELSE 0 END) 
            OVER (
                PARTITION BY p.Property_Id
                ORDER BY mb.ChargeMonth DESC
                ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
            ), 0
        ),

        -- Total outstanding dues (only positive balances)
        TotalOutstandingDues = (
            SELECT SUM(CASE WHEN mb2.MonthNetBalance > 0 THEN mb2.MonthNetBalance ELSE 0 END)
            FROM MonthwiseBalance mb2
            WHERE mb2.CP_Id = @CP_Id 
              AND mb2.Property_Id = p.Property_Id
              AND mb2.ChargeMonth <= @BillingMonth
        ),

        -- Cap allocation to not exceed outstanding dues
        AllocCap = CASE
                     WHEN ISNULL(mr.ReceiptAmountThisMonth,0) > (
                         SELECT SUM(CASE WHEN mb2.MonthNetBalance > 0 THEN mb2.MonthNetBalance ELSE 0 END)
                         FROM MonthwiseBalance mb2
                         WHERE mb2.CP_Id = @CP_Id 
                           AND mb2.Property_Id = p.Property_Id
                           AND mb2.ChargeMonth <= @BillingMonth
                     )
                        THEN (
                            SELECT SUM(CASE WHEN mb2.MonthNetBalance > 0 THEN mb2.MonthNetBalance ELSE 0 END)
                            FROM MonthwiseBalance mb2
                            WHERE mb2.CP_Id = @CP_Id 
                              AND mb2.Property_Id = p.Property_Id
                              AND mb2.ChargeMonth <= @BillingMonth
                        )
                     ELSE ISNULL(mr.ReceiptAmountThisMonth,0)
                   END
    FROM BaseProps p
    JOIN MonthwiseBalance mb
      ON mb.CP_Id = @CP_Id
     AND mb.Property_Id = p.Property_Id
     AND mb.ChargeMonth <= @BillingMonth
    LEFT JOIN MonthReceipt mr
      ON mr.CP_Id = @CP_Id AND mr.Property_Id = p.Property_Id
    LEFT JOIN TotalDueTill td
      ON td.CP_Id = @CP_Id AND td.Property_Id = p.Property_Id
    LEFT JOIN TotalReceiptTillPrev trp
      ON trp.CP_Id = @CP_Id AND trp.Property_Id = p.Property_Id
),
FinalAlloc AS (
    SELECT
        a.Property_Id,
        [Billing Month] = FORMAT(a.BillingMonth, 'MMMM yyyy'),
        [TotalDueTill @BillingMonth]            = a.TotalDueTill,
        [TotalReceiptTill end of previous month]= a.TotalReceiptTillPrev,
        [Arrear Amount] = CASE WHEN a.TotalDueTill > a.TotalReceiptTillPrev
                               THEN a.TotalDueTill - a.TotalReceiptTillPrev ELSE 0 END,
        [ReceiptAmount @BillingMonth] = a.ReceiptAmountThisMonth,
        [Billing Month of due amount] = FORMAT(a.ChargeMonth, 'MMMM yyyy'),
        [Monthwise DueAmount]         = a.MonthwiseDueAmount,
        [Month Net Balance]           = a.MonthNetBalance,

        -- Only allocate to months with positive net balance
        [Receipt To due distribution] =
            CASE 
                WHEN a.MonthNetBalance <= 0 THEN 0  -- Skip months already overpaid
                WHEN a.AllocCap > a.RunningDuePrior THEN
                    CASE WHEN a.AllocCap - a.RunningDuePrior >= a.MonthNetBalance
                         THEN a.MonthNetBalance  -- Use net balance instead of original due
                         ELSE a.AllocCap - a.RunningDuePrior
                    END
                ELSE 0 
            END,

        -- Advance = receipt amount minus total outstanding dues
        [Advance] = CASE
                      WHEN a.ChargeMonth = @BillingMonth
                           AND a.ReceiptAmountThisMonth > ISNULL(a.TotalOutstandingDues, 0)
                        THEN a.ReceiptAmountThisMonth - ISNULL(a.TotalOutstandingDues, 0)
                      ELSE 0
                    END
    FROM AllocRows a
)

-- 1) Detailed allocation rows (only rows that got something)
SELECT 
    Property_Id,
    [Billing Month],
    [TotalDueTill @BillingMonth],
    [TotalReceiptTill end of previous month],
    [Arrear Amount],
    [ReceiptAmount @BillingMonth],
    [Billing Month of due amount],
    [Monthwise DueAmount],
    [Month Net Balance],
    [Receipt To due distribution],
    [Advance]
FROM FinalAlloc
WHERE [Receipt To due distribution] > 0 OR [Advance] > 0
ORDER BY Property_Id, [Billing Month of due amount] DESC;

-- 2) Summary per due month (also carries any Advance on the billing-month row)
SELECT
    [Billing Month of due amount],
    [Sum of Receipt To due distribution] = SUM([Receipt To due distribution]),
    [Advance] = SUM([Advance])
FROM FinalAlloc
WHERE [Receipt To due distribution] > 0 OR [Advance] > 0
GROUP BY [Billing Month of due amount]
ORDER BY TRY_CONVERT(date, '01 ' + [Billing Month of due amount]) DESC;
